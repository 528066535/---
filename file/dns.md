
    这章放在这个位置，也是因为 DNS 和网络也有很大的关系。

### 一. 域名是如何解析的

 最初，由于ip长且难记，通过ip访问网站不方便。所以后来通过发明了DNS服务器，这个时候我们访问网站输入网站域名，DNS服务器就解析我们的域名为ip。
 这样我们实际访问的就是对应的ip地址啦。

 TCP/IP 网络是通过 IP 地址来确定通信对象的，不知道 IP 地址就无法将消息发送给对方，因此，在委托操作系统发送消息时，必须要先查询好对方 的 IP 地址。

 #### DNS 解析查询缓存过程

 * 浏览器 DNS 缓存。首先浏览器会缓存 DNS，缓存过期时间大概是一分钟或者根据TTL属性来设置。如果没有缓存或者过期，则进入下一阶段。
 * 操作系统 DNS 缓存。window系统是一天，mac系统严格根据DNS协议中的TTL。
 * 读取本地的hosts文件。 hosts 可以建立域名到 IP 地址的绑定关系，作为前端，有时候会修改这个地址。（这也会是黑客攻击的一个手段）
 * 路由器缓存。当浏览器及系统缓存中均无域名对应IP则进入路由器缓存中检查。
 * ISP（互联网服务提供商）DNS缓存。当在用户客服端查找不到域名对应IP地址，则将进入ISP DNS缓存中进行查询。比如你用的是电信的网络，则会进入电信的DNS缓存服务器中进行查找。
 * 根域名服务器。当以上均未完成，则进入根服务器进行查询。全球仅有13台根域名服务器，1个主根域名服务器，其余12为辅根域名服务器。根域名收到请求后会查看区域文件记录，若无则将其管辖范围内顶级域名（如.com）服务器IP告诉本地DNS服务器。
 * 顶级域名服务器。顶级域名服务器收到请求后查看区域文件记录，若无则将其管辖范围内主域名服务器的IP地址告诉本地DNS服务器。
 * 主域名服务器。主域名服务器接受到请求后查询自己的缓存，如果没有则进入下一级域名服务器进行查找，并重复该步骤直至找到正确纪录。
 * 保存结果至缓存。本地域名服务器把返回的结果保存到缓存，以备下一次使用，同时将该结果反馈给客户端，客户端通过这个IP地址与web服务器建立链接。

### 二. DNS

 #### 域名结构：

 主机名.次级域名.顶级域名.根域名， 对应 www.example.com.root

 每个域都会有域名服务器，也叫权威域名服务器。

 baidu.com就是一个顶级域名，而 www.baidu.com 却不是顶级域名，他是在 baidu.com 这个域里的一叫做www的主机。

 一级域之后还有二级域，三级域，只要我买了一个顶级域，并且我搭建了自己BIND服务器（或者其他软件搭建的）注册到互联网中，那么我就可以随意在前面多加几个域了。

 比如a.www.baidu.com，在这个网址中，www.baidu.com变成了一个二级域而不是一台主机，主机名是a。

 #### 域名服务器

 能提供域名解析的服务器，上面的记录类型可以是A(address)记录，NS记录（name server），MX（mail），CNAME等。

 A记录是什么意思呢，就是记录一个IP地址和一个主机名字，比如我这个域名服务器所在的域test.baidu.com，我们知道这是一个二级的域名，然后我在里面有一条A记录,记录了主机为a的IP，查到了就返回给你了。

 如果我现在要想baidu.com这个域名服务器查询a.test.baidu.com，那么这个顶级域名服务器就会发现你请求的这个网址在test.baidu.com这个域中，我这里记录了这个二级域的域名服务器test.baidu.com的NS的IP。我返回给你这个地址你再去查主机为a的主机把。

 这些域内的域名服务器都称为权威服务器，直接提供DNS查询服务。（这些服务器可不会做递归哦）

 NS记录 解析服务器记录。用来表明由哪台服务器对该域名进行解析。这里的NS记录只对子域名生效。

 DNS 的结构跟Linux 文件系统很相似，像一棵倒立的树。根域名服务器只管理顶级域，同时把每个顶级域的管理委派给各个顶级域，所以当你想要申请com下的二级域名时，
 找com域名注册中心就好了。

 #### DNS解析过程

 1、在浏览器中输入www . qq .com 域名，操作系统会先检查自己本地的hosts文件是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。

 2、如果hosts里没有这个域名的映射，则查找本地DNS解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。

 3、如果hosts与本地DNS解析器缓存都没有相应的网址映射关系，首先会找TCP/ip参数中设置的首选DNS服务器，在此我们叫它本地DNS服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。

 4、如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。

 5、如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至13台根DNS，根DNS服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(http://qq.com)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找http://qq.com域服务器，重复上面的动作，进行查询，直至找到www . qq .com主机。

 6、如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。

 ![dns解析过程](/img/dns-1.jpg)

### 三. DNS 预解析

 没有缓存的情况下，一次预解析的大概时间在 20ms到120ms之间。在移动端中，首屏本来就浪费时间，还要再等待一段时间，这样的确是浪费时间。
 那么直接上代码：

 ```
 <meta http-equiv="x-dns-prefetch-control" content="on">
 <link rel="dns-prefetch" href="//www.zhix.net">
 ```

 的确挺简单的，只要上两行代码就可以优化100ms的时间了。

 有人说了，我页面都加载出来了，还需要解析DNS吗？这个不是给自己页面用的，而是当项目需要引用一些第三方或者线上的库的时候，可以加上预加载，但是
 如果滥用也会造成 DNS 查询超标的情况。



